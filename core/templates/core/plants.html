{% extends "core/base.html" %}
{% load static %}
{% block title %}Plants{% endblock %}
{% block content %}
<section class="py-5">
  <div class="container">
    <h2 class="text-center text-success fw-bold mb-4">All Plants</h2>

    <!-- Search form -->
    <form method="get" class="mb-4">
      <div class="input-group mx-auto" style="max-width: 600px;">
        <input type="text" id="plant-search" name="q" value="{{ request.GET.q }}" 
               placeholder="Search plants..." class="form-control">
        <button type="submit" class="btn btn-success">Search</button>
      </div>
      <!-- Suggestions dropdown -->
      <ul id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000; max-width:600px; left:50%; transform:translateX(-50%);"></ul>
    </form>

    <div class="row">
      {% if plants %}
        {% for plant in plants %}
        <div class="col-md-3 mb-4">
          <div class="card h-100 shadow-sm">
            {% if plant.image %}
            <img src="{{ plant.image.url }}" class="card-img-top" alt="{{ plant.name }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <!-- Name + Price together -->
              <h5 class="card-title fw-bold">
                {{ plant.name }}
                {% if plant.price %}
                  – <span class="text-success">₹{{ plant.price }}</span>
                {% endif %}
              </h5>
              <p class="card-text text-muted flex-grow-1">{{ plant.description|truncatewords:15 }}</p>

              <!-- Button to open modal -->
              <a href="#" class="btn btn-success btn-sm mt-auto" data-bs-toggle="modal" data-bs-target="#plantModal{{ plant.id }}">
                View Details
              </a>
            </div>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="plantModal{{ plant.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">{{ plant.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                {% if plant.image %}
                <img src="{{ plant.image.url }}" class="img-fluid rounded mb-3" alt="{{ plant.name }}">
                {% endif %}
                <p>{{ plant.description }}</p>
                {% if plant.price %}
                <p class="fw-bold text-success">Price: ₹{{ plant.price }}</p>
                {% endif %}
                <p><strong>Availability:</strong> {{ plant.availability }}</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-center text-muted">No plants found.</p>
      {% endif %}
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchBox = document.getElementById("plant-search");
  const suggestions = document.getElementById("suggestions");

  searchBox.addEventListener("input", function() {
    const query = this.value;
    if (query.length < 1) {
      suggestions.innerHTML = "";
      return;
    }

    fetch(`/plants/autocomplete/?term=${query}`)
      .then(response => response.json())
      .then(data => {
        suggestions.innerHTML = "";
        data.forEach(item => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          li.textContent = item;
          li.addEventListener("click", () => {
            searchBox.value = item;
            suggestions.innerHTML = "";
          });
          suggestions.appendChild(li);
        });
      });
  });
});
</script>

{% endblock %}
